### 简介

正如几何上用坐标空间来描述坐标集合，色彩空间用数学方式来描述颜色集合。常见的3 个基本色彩模型是[RGB](https://baike.baidu.com/item/RGB),[CMYK](https://baike.baidu.com/item/CMYK)和[YUV](https://baike.baidu.com/item/YUV)。

YUV，分为三个分量，“Y”表示明亮度（Luminance或Luma），也就是灰度值；而“U”(即Cb)和“V”(即Cr) 表示的则是色度（Chrominance或Chroma），作用是描述影像色彩及饱和度，用于指定像素的颜色。

与我们熟知的RGB类似，YUV也是一种颜色编码方法，主要用于电视系统以及模拟视频领域，它将亮度信息（Y）与色彩信息（UV）分离，没有UV信息一样可以显示完整的图像，只不过是黑白的，这样的设计很好地解决了彩色电视机与黑白电视的兼容问题。并且，YUV不像RGB那样要求三个独立的视频信号同时传输，所以用YUV方式传送占用极少的频宽。

YUV码流的存储格式其实与其采样的方式密切相关，主流的采样方式有三种，YUV4:4:4，YUV4:2:2，YUV4:2:0。



### 采样方式

YUV 图像的主流采样方式有如下三种：

- YUV 4:4:4 采样
- YUV 4:2:2 采样
- YUV 4:2:0 采样

用三个图来直观地表示采集的方式吧，以黑点表示采样该像素点的Y分量，以空心圆圈表示采用该像素点的UV分量。

![image-20210721184747283](.asserts/image-20210721184747283.png)

先记住下面这段话，以后提取每个像素的YUV分量会用到。

1. YUV 4:4:4采样，每一个Y对应一组UV分量。表示全像素[点阵](https://baike.baidu.com/item/点阵)(YYYYCbCrCbCrCbCrCbCr），用于高质量视频应用、演播室以及专业视频产品。
2. YUV 4:2:2采样，每两个Y共用一组UV分量。 4：2：2表示每4个像素有4个亮度分量，4个色度分量（YYYYCbCrCbCr），是DVD、数字电视、HDTV 以及其它消费类视频设备的最常用格式。
3. YUV 4:2:0采样，每四个Y共用一组UV分量。 每4个像素有4个亮度分量，2个色度分量 (YYYYCbCr），仅采样奇数扫描线，是便携式视频设备（MPEG-4）以及电视会议（H.263）最常用格式。



### YUV分类

YUV格式有两大类：planar（平面）和packed（紧凑）。

对于planar的YUV格式，先连续存储所有像素点的Y，紧接着存储所有像素点的U，随后是所有像素点的V。

对于packed的YUV格式，每个像素点的Y,U,V是连续交叉存储的。



以分辨率8*4为例，数据存储方式如下：

##### 1、yuv420p（yuv420）（planar）【I420】：

YYYYYYYY

YYYYYYYY

YYYYYYYY

YYYYYYYY

UUUUUUUU

VVVVVVVV



##### 2、YV12（yuv420）：

YYYYYYYY

YYYYYYYY

YYYYYYYY

YYYYYYYY

VVVVVVVV

UUUUUUUU



##### 3、yuv420sp（yuv420）：

YYYYYYYY

YYYYYYYY

YYYYYYYY

YYYYYYYY

UVUVUVUV

UVUVUVUV



##### 4、NV12、NV21（属于YUV420）

![image-20210721184049385](.asserts/image-20210721184049385.png)

NV12和NV21属于YUV420格式，是一种two-plane模式，即Y和UV分为两个Plane，但是UV（CbCr）为交错存储，而不是分为三个plane。其提取方式与上一种类似，即Y’00、Y’01、Y’10、Y’11共用Cr00、Cb00。



### 存储方式

**YV12，YU12格式（属于YUV420）**

YU12和YV12属于YUV420格式，也是一种Plane模式，将Y、U、V分量分别打包，依次存储。其每一个像素点的YUV数据提取遵循YUV420格式的提取方式，即4个Y分量共用一组UV。注意，上图中，Y'00、Y'01、Y'10、Y'11共用Cr00、Cb00，其他依次类推。

![img](.asserts/141726_CZLj_1024767.png)



**NV12、NV21（属于YUV420）**

NV12和NV21属于YUV420格式，是一种two-plane模式，即Y和UV分为两个Plane，但是UV（CbCr）为交错存储，而不是分为三个plane。其提取方式与上一种类似，即Y'00、Y'01、Y'10、Y'11共用Cr00、Cb00。

![img](.asserts/141744_Wsvd_1024767.png)



**YUVY 格式 （属于YUV422）**

YUVY为YUV422采样的存储格式中的一种，相邻的两个Y共用其相邻的两个Cb、Cr，分析，对于像素点Y'00、Y'01 而言，其Cb、Cr的值均为 Cb00、Cr00，其他的像素点的YUV取值依次类推。

![img](.asserts/08141455_yH58.png)



**UYVY 格式 （属于YUV422）**

UYVY格式也是YUV422采样的存储格式中的一种，只不过与YUYV不同的是UV的排列顺序不一样而已，还原其每个像素点的YUV值的方法与上面一样。

![img](.asserts/08141455_BHdN.png)

**YUV422P（属于YUV422）**

YUV422P也属于YUV422的一种，它是一种Plane模式，即平面模式，并不是将YUV数据交错存储，而是先存放所有的Y分量，然后存储所有的U（Cb）分量，最后存储所有的V（Cr）分量，如上图所示。其每一个像素点的YUV值提取方法也是遵循YUV422格式的最基本提取方法，即两个Y共用一个UV。比如，对于像素点Y'00、Y'01 而言，其Cb、Cr的值均为 Cb00、Cr00。

![img](.asserts/141625_Nmib_1024767.png)

YUV420 planar数据， 以720×488大小图象YUV420 planar为例，

其存储格式是： 共大小为(720×480×3>>1)字节，

分为三个部分:Y,U和V

Y分量：  (720×480)个字节 

U(Cb)分量：(720×480>>2)个字节

V(Cr)分量：(720×480>>2)个字节

三个部分内部均是行优先存储，三个部分之间是Y,U,V 顺序存储。

即YUV数据的0－－720×480字节是Y分量值，     

720×480－－720×480×5/4字节是U分量   

720×480×5/4 －－720×480×3/2字节是V分量。



### NV21与I420

Android Camera对象通过setPreviewCallback 函数，在onPreviewFrame(byte[] data,Camera camera)中回调采集的数据就是NV21格式。而x264编码的输入数据却为I420格式。

因此，当我们采集到摄像头数据之后需要将NV21转为I420。

NV21和I420都是属于YUV420格式。而NV21是一种two-plane模式，即Y和UV分为两个Plane(平面)，但是UV（CbCr）交错存储，2个平面，而不是分为三个。这种排列方式被称之为YUV420SP，而I420则称之为YUV420P。(Y:明亮度、灰度，UV:色度、饱和度)

下图是大小为<font color=red>4x4</font>的NV21数据:Y1、Y2、Y5、Y6共用V1与U1,

![image-20210721193523827](.asserts/image-20210721193523827.png)

而I420则是

![image-20210721193540283](.asserts/image-20210721193540283.png)

可以看出无论是哪种排列方式，YUV420的数据量都为: w**h+w/2**h/2+w/2**h/2 即为w**h*3/2。



### 开发

手机摄像头的图像数据来源于摄像头硬件的图像传感器，这个图像传感器被固定到手机上后会有一个默认的取景方向，这个取景方向坐标原点于手机横放时的左上角。当应用是横屏时候：图像传感器方向与屏幕自然方向原点一致。而当手机为竖屏时:

![image-20210721193055745](.asserts/image-20210721193055745.png)

传感器与屏幕自然方向不一致，将图像传感器的坐标系逆时针旋转90度，才能显示到屏幕的坐标系上。所以看到的画面是逆时针旋转了90度的，因此我们需要将图像顺时针旋转90度才能看到正常的画面。而Camera对象提供一个setDisplayOrientation接口能够设置预览显示的角度：

![image-20210721193126087](.asserts/image-20210721193126087.png)

根据文档，配置完Camera之后预览确实正常了，但是在onPreviewFrame中回调获得的数据依然是逆时针旋转了90度的。所以如果需要使用预览回调的数据，还需要对onPreviewFrame回调的byte[] 进行旋转。

旋转前：

![image-20210721193213737](.asserts/image-20210721193213737.png)

后置摄像头需要顺时针旋转90度，旋转后：

![image-20210721193242358](.asserts/image-20210721193242358.png)



前置摄像头需要逆时针旋转90度，旋转后：

![image-20210721193317820](.asserts/image-20210721193317820.png)

前置摄像头可能还需要进一步镜像处理，镜像后：

![image-20210721193446644](.asserts/image-20210721193446644.png)



### 互转

##### NV21转I420

Y数据按顺序完整复制,U数据则是从整个Y数据之后加一个字节再每隔一个字节取一次。



##### 4：2：2 **和4：2：0** 转换

最简单的方式：YUV4:2:2 —> YUV4:2:0 Y不变，将U和V信号值在行(垂直方向)在进行一次隔行抽样。

YUV4:2:0 —> YUV4:2:2 Y不变，将U和V信号值的每一行分别拷贝一份形成连续两行数据。

在YUV420中，一个像素点对应一个Y，一个2X2的小方块对应一个U和V。对于所有YUV420图像，它们的Y值排列是完全相同的，因为只有Y的图像就是灰度图像。YUV420sp与YUV420p的数据格式它们的UV排列在原理上是完全不同的。420p它是先把U存放完后，再存放V，也就是说UV它们是连续的。而420sp它是UV、UV这样交替存放的。假设一个分辨率为8X4的YUV图像，它们的格式如图：

YUV420sp格式如下图：

![image-20210721185157026](.asserts/image-20210721185157026.png)



YUV420p数据格式如下图：

![image-20210721185224257](.asserts/image-20210721185224257.png)



##### RGB 到 YUV 的转换

对于图像显示器来说，它是通过 RGB 模型来显示图像的，而在传输图像数据时又是使用 YUV 模型，这是因为 YUV 模型可以节省带宽。因此就需要采集图像时将 RGB 模型转换到 YUV 模型，显示时再将 YUV 模型转换为 RGB 模型。

RGB 到 YUV 的转换，就是将图像所有像素点的 R、G、B 分量转换到 Y、U、V 分量。

有如下公式进行转换：

![img](.asserts/rgba-to-yuv.webp)

![img](.asserts/rgba-to-yuv-2.webp)

此时的转换结束后，每个像素点都有完整的 Y、U、V 分量。而之前提到 Y 和 UV 分量是可以分离的，可以通过不同的采样方式，可以将图像的 Y、U、V 分量重新组合。



